# =============================================================================
# Module Workflow: Port Scanning
# =============================================================================

kind: module
name: single-target-port-scan
description: Probe HTTP services across common ports on a single target
tags: portscan, rustscan, network

# -----------------------------------------------------------------------------
# PARAMS SECTION
# -----------------------------------------------------------------------------
params:
  - name: httpFile
    default: "{{Output}}/probing/http-{{TargetSpace}}.txt"

  - name: openPortsFile
    default: "{{Output}}/portscan/open-ports-{{TargetSpace}}.txt"

  - name: httpPortFingerprintJsonlFile
    default: "{{Output}}/portscan/http-port-fingerprint-{{TargetSpace}}.jsonl"

  - name: httpPortFingerprintFilteredJsonlFile
    default: "{{Output}}/portscan/http-port-fingerprint-filtered-{{TargetSpace}}.jsonl"

  - name: httpPortFingerprintMarkdownFile
    default: "{{Output}}/portscan/http-port-fingerprint-filtered-{{TargetSpace}}.md"

  - name: commonHttpPorts
    default: "80,443,8080,8443,8000,8008,81,82,8081,8888,3000,3001,3002,5000,5001,5002,9000,9001,9080,9443,7000,7001,7002,7003,7004,7005,7006,7007,7008,7009,7010,7011,7012,7013,7014,7015,7016,7017,7018,7019,7020,7021,7022,7023,7024,7025,7026,7027,7028,7029,7030,7031,7032,7033,7034,7035,7036,7037,7038,7039,7040,7041,7042,7043,7044,7045,7046,7047,7048,7049,7050,7051,7052,7053,7054,7055,7056,7057,7058,7059,7060,7061,7062,7063,7064,7065,7066,7067,7068,7069,7070,7071,7072,7073,7074,7075,7076,7077,7078,7079,7080,7081,7082,7083,7084,7085,7086,7087,7088,7089"
  - name: commonHttpsPort
    # default: "1-65535"
    default: "80,443,8080,8443,8000,8008,81,82,8081,8888,3000,3001,3002,5000,5001,5002,9000,9001,9080,9443,7000,7001,7002,7003,7004,7005,7006,7007,7008,7009,7010,7011,7012,7013,7014,7015,7016,7017,7018,7019,7020,7021,7022,7023,7024,7025,7026,7027,7028,7029,7030,7031,7032,7033,7034,7035,7036,7037,7038,7039,7040,7041,7042,7043,7044,7045,7046,7047,7048,7049,7050,7051,7052,7053,7054,7055,7056,7057,7058,7059,7060,7061,7062,7063,7064,7065,7066,7067,7068,7069,7070,7071,7072,7073,7074,7075,7076,7077,7078,7079,7080,7081,7082,7083,7084,7085,7086,7087,7088,7089"

  # - name: rateRustScan
  #   default: "{{ threads * 400 }}"
  - name: httpThreads
    default: "{{ threads * 3 }}"
  - name: httpTimeout
    default: "15"
  - name: defaultUA
    default: "User-Agent: Mozilla/5.0 (compatible; Osmedeus/v5; +https://github.com/j3ssie/osmedeus)"

  # disable this by default as it alert a lot of Cloud Provider
  - name: enable_rustscan 
    type: bool
    default: false

# -----------------------------------------------------------------------------
# DEPENDENCIES SECTION
# -----------------------------------------------------------------------------
dependencies:
  commands:
    - httpx

  variables:
    - name: Target
      type: string
      required: true

# -----------------------------------------------------------------------------
# REPORTS SECTION
# -----------------------------------------------------------------------------
reports:
  - name: open-ports
    path: "{{openPortsFile}}"
    type: text
    description: List of open ports

  - name: http-services
    path: "{{httpPortFingerprintJsonlFile}}"
    type: text
    description: HTTP services on open ports

# -----------------------------------------------------------------------------
# STEPS SECTION
# -----------------------------------------------------------------------------
steps:
  # ---------------------------------------------------------------------------
  # Setup: Create output folder
  # ---------------------------------------------------------------------------
  - name: create-output-folder
    type: function
    log: "Creating fingerprint output folder"
    functions:
      # - 'create_folder("{{Output}}/fingerprint")'
      - 'create_folder("{{Output}}/probing")'
      - 'create_folder("{{Output}}/portscan")'

  - name: generate-input-file
    type: function
    log: "Generating input file"
    functions:
      - exec_cmd("echo {{Target}} | httpx -silent -t {{httpThreads}} -nf -timeout {{httpTimeout}} >> {{httpFile}}")
      - exec_cmd("cat {{Target}} | httpx -silent -t {{httpThreads}} -nf -timeout {{httpTimeout}} >> {{httpFile}}")


  # ---------------------------------------------------------------------------
  # HTTP probing on open ports
  # ---------------------------------------------------------------------------
  - name: http-probe-ports-edge-case
    type: bash
    log: "Probing for HTTP services on open ports againt the input direct"
    commands: 
      # this is for when the input is a string or a file
      - echo '{{Target}}' | httpx -H '{{defaultUA}}' -timeout {{httpTimeout}} -t {{httpThreads}} -no-fallback -no-color -silent -json -title -favicon -hash sha256 -jarm -tech-detect -status-code -cdn -tls-grab -ztls -vhost -follow-host-redirects -include-chain -ports 'http:{{commonHttpPorts}},https:{{commonHttpsPort}}' >> {{httpPortFingerprintJsonlFile}}
      - cat {{Target}} | httpx -H '{{defaultUA}}' -timeout {{httpTimeout}} -t {{httpThreads}} -no-fallback -no-color -silent -json -title -favicon -hash sha256 -jarm -tech-detect -status-code -cdn -tls-grab -ztls -vhost -follow-host-redirects -include-chain -ports 'http:{{commonHttpPorts}},https:{{commonHttpsPort}}' >> {{httpPortFingerprintJsonlFile}}
    on_error: 
      - action: continue # expected error if no port found

  - name: http-probe-ports-for-open-port
    type: bash
    log: "Probing for HTTP services on open ports"
    pre_condition: 'file_exists("{{httpFile}}")'
    commands: 
      # doing HTTP probing as normal
      - cat {{httpFile}} | httpx -H '{{defaultUA}}' -timeout {{httpTimeout}} -t {{httpThreads}} -no-fallback -no-color -silent -json -title -favicon -hash sha256 -jarm -tech-detect -status-code -cdn -tls-grab -ztls -vhost -follow-host-redirects -include-chain -ports 'http:{{commonHttpPorts}},https:{{commonHttpsPort}}' >> {{httpPortFingerprintJsonlFile}}
      - cat {{httpPortFingerprintJsonlFile}} | jq -r '[.host_ip,.port] | join(\":\")' | sort -u >> {{openPortsFile}}
    on_error: 
      - action: continue # expected error if no port found

  - name: sort-http-results
    type: function
    log: "Sorting HTTP probe results"
    pre_condition: 'file_exists("{{httpPortFingerprintJsonlFile}}")'
    functions:
      - jsonl_filter("{{httpPortFingerprintJsonlFile}}", "{{httpPortFingerprintFilteredJsonlFile}}", "url,title,status_code,content_length,lines,webserver,tech,cdn")
      - 'convert_jsonl_to_markdown("{{httpPortFingerprintFilteredJsonlFile}}", "{{httpPortFingerprintMarkdownFile}}")'

